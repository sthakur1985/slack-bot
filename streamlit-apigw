import streamlit as st
import requests
import base64

# Replace with your actual API Gateway endpoint
API_GATEWAY_URL = "https://3rjvbdzw5a.execute-api.eu-west-2.amazonaws.com"

st.title("Change Request Submission Form")

# Input fields
cr_name = st.text_input("CR Name")
cr_details = st.text_area("CR Details", height=150)
uploaded_file = st.file_uploader("Upload Supporting Document", type=["pdf", "docx", "txt"])

if st.button("Submit CR"):
    if cr_name and cr_details:
        st.success(f"Preparing to submit CR '{cr_name}' to API Gateway...")

        # Prepare request payload
        payload = {
            "cr_name": cr_name,
            "cr_details": cr_details
        }

        # If file is uploaded, encode it to Base64 to send in JSON
        if uploaded_file is not None:
            file_content = uploaded_file.read()
            payload["file_name"] = uploaded_file.name
            payload["file_content_base64"] = base64.b64encode(file_content).decode("utf-8")

        try:
            # Send POST request to API Gateway
            response = requests.post(API_GATEWAY_URL, json=payload)

            if response.status_code == 200:
                st.success("✅ CR submitted successfully to API Gateway!")
                st.json(response.json())
            else:
                st.error(f"❌ Failed to submit. Status Code: {response.status_code}")
                st.text(response.text)
        except Exception as e:
            st.error(f"Error while calling API Gateway: {e}")

    else:
        st.error("❌ Please fill in CR Name and CR Details before submitting.")
